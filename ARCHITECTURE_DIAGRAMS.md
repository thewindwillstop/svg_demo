# SVG Generation Service - 架构图解

## 🏗️ 系统架构总览

```
┌─────────────────────────────────────────────────────────────────┐
│                        SVG Generation Service                   │
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
│  │   Client    │    │   Browser   │    │  API Tools  │        │
│  │    Apps     │    │             │    │             │        │
│  └─────────────┘    └─────────────┘    └─────────────┘        │
│           │                 │                 │                │
│           └─────────────────┼─────────────────┘                │
│                             │                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                 HTTP API Gateway                        │   │
│  │              localhost:8080                             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                             │                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                 Handler Layer                           │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐      │   │
│  │  │SVG.IO   │ │Recraft  │ │Claude   │ │Health   │      │   │
│  │  │Handler  │ │Handler  │ │Handler  │ │Handler  │      │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                             │                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │               Service Manager                           │   │
│  │                                                         │   │
│  │  ┌─────────────┐    ┌─────────────┐                   │   │
│  │  │ Translation │    │   Provider  │                   │   │
│  │  │   Service   │    │   Router    │                   │   │
│  │  └─────────────┘    └─────────────┘                   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                             │                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                Provider Layer                           │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐                  │   │
│  │  │SVG.IO   │ │Recraft  │ │Claude   │                  │   │
│  │  │Service  │ │Service  │ │Service  │                  │   │
│  │  └─────────┘ └─────────┘ └─────────┘                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                             │                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │               External APIs                             │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐      │   │
│  │  │SVG.IO   │ │Recraft  │ │Claude   │ │OpenAI   │      │   │
│  │  │  API    │ │  API    │ │  API    │ │  API    │      │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘      │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 🔄 数据流图

### 1. SVG.IO Provider 流程 (带翻译)
```
中文输入 → 参数验证 → 翻译服务 → SVG.IO API → 图片URL → 下载SVG → 返回文件

┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│"一只猫" │ ►  │  验证   │ ►  │OpenAI   │ ►  │SVG.IO   │ ►  │下载文件 │
│         │    │  参数   │    │翻译API  │    │ API     │    │返回SVG  │
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
                                   │
                                   ▼
                              "a cute cat"
```

### 2. Recraft Provider 流程 (中文直接)
```
中文输入 → 参数验证 → 提示词优化 → Recraft API → 图片URL → 矢量化 → 返回SVG

┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│"简约图标"│ ►  │  验证   │ ►  │添加无背景│ ►  │Recraft  │ ►  │Vectorize│
│         │    │  参数   │    │提示词   │    │ API     │    │API      │
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
```

### 3. Claude Provider 流程 (AI代码生成)
```
描述输入 → 参数验证 → 构建提示词 → Claude API → SVG代码 → Base64编码 → Data URL

┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│"几何山景"│ ►  │  验证   │ ►  │增强提示词│ ►  │Claude   │ ►  │编码为   │
│         │    │  参数   │    │         │    │ API     │    │DataURL  │
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
```

## 🧩 模块关系图

```
                    ┌─────────────────────────┐
                    │      main.go            │
                    │   (应用启动入口)          │
                    └───────────┬─────────────┘
                                │
                    ┌───────────▼─────────────┐
                    │   HTTP Router           │
                    │  (路由注册与分发)        │
                    └─┬─────────┬─────────────┘
                      │         │
        ┌─────────────▼─┐   ┌───▼──────────┐
        │   Handlers    │   │    Utils     │
        │ (请求处理器)   │   │ (工具函数)    │
        └─┬─────────────┘   └──────────────┘
          │
    ┌─────▼─────┐
    │ Service   │
    │ Manager   │
    │(业务编排) │
    └─┬─────────┘
      │
┌─────▼──────┬──────────┬───────────┐
│  SVG.IO    │ Recraft  │  Claude   │
│ Service    │ Service  │ Service   │
│(Provider实现)│       │           │
└─┬──────────┴────┬─────┴─────┬─────┘
  │               │           │
┌─▼─────┐  ┌─────▼──┐  ┌─────▼──┐
│SVG.IO │  │Recraft │  │Claude  │
│ API   │  │  API   │  │  API   │
└───────┘  └────────┘  └────────┘
```

## 🎯 接口设计图

```
API端点层次结构:

/
├── v1/
│   ├── images/
│   │   ├── [POST]                 → SVG.IO JSON元数据
│   │   ├── svg [POST]             → SVG.IO 直接下载
│   │   ├── svgio [POST]           → SVG.IO 直接下载 (别名)
│   │   ├── recraft/
│   │   │   ├── [POST]             → Recraft JSON元数据  
│   │   │   └── svg [POST]         → Recraft 直接下载
│   │   └── claude/
│   │       ├── [POST]             → Claude JSON元数据
│   │       └── svg [POST]         → Claude 直接下载
│   └── health [GET]               → 健康检查
└── [OPTIONS] *                    → CORS预检
```

## 🔧 组件依赖图

```
┌─────────────────────────────────────────────────────────────┐
│                    External Dependencies                    │
│                                                             │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐       │
│  │SVG.IO   │  │Recraft  │  │Claude   │  │OpenAI   │       │
│  │API      │  │API      │  │API      │  │API      │       │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘       │
└─────────────────────────────────────────────────────────────┘
           ▲          ▲          ▲          ▲
           │          │          │          │
┌─────────────────────────────────────────────────────────────┐
│                    Provider Layer                           │
│                                                             │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐                     │
│  │SVG.IO   │  │Recraft  │  │Claude   │                     │
│  │Service  │  │Service  │  │Service  │                     │
│  └─────────┘  └─────────┘  └─────────┘                     │
└─────────────────────────────────────────────────────────────┘
           ▲          ▲          ▲
           │          │          │
           └──────────┼──────────┘
                      │
┌─────────────────────────────────────────────────────────────┐
│                  Business Layer                             │
│                                                             │
│  ┌─────────────┐        ┌─────────────┐                    │
│  │   Service   │◄──────►│Translation  │                    │
│  │   Manager   │        │   Service   │                    │
│  └─────────────┘        └─────────────┘                    │
└─────────────────────────────────────────────────────────────┘
           ▲                      ▲
           │                      │
┌─────────────────────────────────────────────────────────────┐
│                 Presentation Layer                          │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   Handlers                          │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐  │   │
│  │  │SVG.IO   │ │Recraft  │ │Claude   │ │Health   │  │   │
│  │  │Handler  │ │Handler  │ │Handler  │ │Handler  │  │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘  │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
           ▲
           │
┌─────────────────────────────────────────────────────────────┐
│                   HTTP Gateway                              │
│                 (Gorilla Mux Router)                        │
└─────────────────────────────────────────────────────────────┘
```

## 🔀 错误处理流程图

```
┌─────────────┐
│HTTP Request │
└─────┬───────┘
      │
┌─────▼───────┐       ┌─────────────┐
│参数验证     │ ────► │400 Bad      │
│             │ 失败   │Request      │
└─────┬───────┘       └─────────────┘
      │成功
┌─────▼───────┐       ┌─────────────┐
│翻译服务     │ ────► │继续处理     │
│(可选)       │ 失败   │(使用原文)   │
└─────┬───────┘       └─────────────┘
      │成功
┌─────▼───────┐       ┌─────────────┐
│Provider调用 │ ────► │502 Bad      │
│             │ 失败   │Gateway      │
└─────┬───────┘       └─────────────┘
      │成功
┌─────▼───────┐       ┌─────────────┐
│响应处理     │ ────► │500 Internal │
│             │ 失败   │Server Error │
└─────┬───────┘       └─────────────┘
      │成功
┌─────▼───────┐
│返回结果     │
└─────────────┘
```

## 📊 性能优化策略图

```
┌─────────────────────────────────────────────────────────────┐
│                    性能优化策略                              │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   连接池    │  │   超时控制  │  │   并发限制  │         │
│  │   复用      │  │             │  │             │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   内存优化  │  │   流式处理  │  │   日志优化  │         │
│  │             │  │             │  │             │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   缓存策略  │  │   负载均衡  │  │   监控告警  │         │
│  │  (未来)     │  │  (未来)     │  │  (未来)     │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

## 🚀 扩展性架构

```
当前单体架构:
┌─────────────────────────────────────────┐
│          SVG Generation Service         │
│                                         │
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐      │
│  │API  │ │Bus  │ │Prov │ │Utils│      │
│  │Layer│ │Logic│ │Layer│ │     │      │
│  └─────┘ └─────┘ └─────┘ └─────┘      │
└─────────────────────────────────────────┘

未来微服务架构:
┌──────────┐  ┌──────────┐  ┌──────────┐
│ Gateway  │  │Translation│  │   File   │
│ Service  │  │ Service   │  │ Service  │
└─────┬────┘  └─────┬────┘  └─────┬────┘
      │             │             │
      └─────────────┼─────────────┘
                    │
      ┌─────────────▼─────────────┐
      │                           │
┌─────▼─────┐ ┌─────▼─────┐ ┌─────▼─────┐
│   SVG     │ │  Recraft  │ │  Claude   │
│ Service   │ │  Service  │ │  Service  │
└───────────┘ └───────────┘ └───────────┘
```

---

## 📝 架构决策记录

### ADR-001: 为什么选择Go语言？
- **原因**: 高并发性能、内存安全、部署简单
- **替代方案**: Node.js、Python、Java
- **决策**: Go的goroutine和channel机制完美契合高并发需求

### ADR-002: 为什么采用单体架构？
- **原因**: 项目初期，团队规模小，部署运维简单
- **替代方案**: 微服务架构
- **决策**: 预留微服务拆分接口，支持未来演进

### ADR-003: 为什么选择多Provider聚合？
- **原因**: 降低单点故障风险，提供差异化能力
- **替代方案**: 单一Provider
- **决策**: 通过统一接口实现Provider切换

### ADR-004: 为什么翻译只对SVG.IO生效？
- **原因**: Recraft和Claude原生支持中文
- **替代方案**: 全局翻译
- **决策**: 按需翻译，节省成本和时间

---

*"架构的本质是管理复杂性"*

**Architecture Documentation - SVG Generation Service v1.0**
